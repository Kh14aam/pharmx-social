(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[598],{9242:function(e,o,n){Promise.resolve().then(n.bind(n,6347))},6347:function(e,o,n){"use strict";n.r(o),n.d(o,{default:function(){return i}});var t=n(7437),r=n(2265),a=n(9376);function s(){let e=(0,a.useRouter)(),o=(0,a.useSearchParams)(),[n,s]=(0,r.useState)(!1);return(0,r.useEffect)(()=>{(async()=>{if(n)return;let t=o.get("code"),r=o.get("error"),a=o.get("state");if(console.log("[Login Callback] Received:",{code:!!t,error:r,state:a}),r){console.error("[Login Callback] OAuth error:",r),s(!0),e.push("/login");return}if(!t){console.error("[Login Callback] No authorization code received"),s(!0),e.push("/login");return}if(a!==localStorage.getItem("oauth_state")){console.error("[Login Callback] State mismatch - possible CSRF attack"),s(!0),e.push("/login");return}try{console.log("[Login Callback] Exchanging code with backend...");let o="https://pharmx-api.kasimhussain333.workers.dev",n=await fetch("".concat(o,"/oauth/google/exchange"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t})});if(console.log("[Login Callback] Backend response status:",n.status),!n.ok){let o=await n.text();console.error("[Login Callback] Backend error:",o),s(!0),e.push("/login");return}let r=await n.json();console.log("[Login Callback] Success:",{hasUser:!!r.user,hasTokens:!!r.tokens});let{user:a,tokens:i}=r;if(a&&(null==i?void 0:i.id_token)){localStorage.setItem("pharmx_user",JSON.stringify(a)),localStorage.setItem("pharmx_token",i.id_token),localStorage.removeItem("oauth_state"),console.log("[Login Callback] Checking for existing profile...");try{let n=await fetch("".concat(o,"/profile"),{method:"GET",headers:{Authorization:"Bearer ".concat(i.id_token),"Content-Type":"application/json"}});if(n.ok){let o=await n.json();if(console.log("[Login Callback] Profile found:",{hasName:!!o.name}),o&&o.name){console.log("[Login Callback] Existing user - redirecting to app"),s(!0),e.push("/app/voice");return}}console.log("[Login Callback] No profile found - redirecting to onboarding"),s(!0),e.push("/onboarding");return}catch(o){console.log("[Login Callback] Profile check failed (new user) - redirecting to onboarding"),s(!0),e.push("/onboarding");return}}console.error("[Login Callback] Invalid response format"),s(!0),e.push("/login")}catch(o){console.error("[Login Callback] Network error:",o),s(!0),e.push("/login")}})()},[o,e,n]),(0,t.jsx)("div",{className:"min-h-screen bg-black flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-white",children:"Completing sign in..."})]})})}function i(){return(0,t.jsx)(r.Suspense,{fallback:(0,t.jsx)("div",{className:"min-h-screen bg-black flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-white",children:"Loading..."})]})}),children:(0,t.jsx)(s,{})})}},9376:function(e,o,n){"use strict";var t=n(5475);n.o(t,"usePathname")&&n.d(o,{usePathname:function(){return t.usePathname}}),n.o(t,"useRouter")&&n.d(o,{useRouter:function(){return t.useRouter}}),n.o(t,"useSearchParams")&&n.d(o,{useSearchParams:function(){return t.useSearchParams}})}},function(e){e.O(0,[971,117,744],function(){return e(e.s=9242)}),_N_E=e.O()}]);