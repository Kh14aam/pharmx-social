(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[705],{456:function(e,t,s){Promise.resolve().then(s.bind(s,7870))},7870:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return j}});var a=s(7821),n=s(8078),r=s(7469),c=s(7769),i=s(2211),l=s(20),o=s(5118),d=s(3116),u=s(1996),m=s(2780),h=s(2212),f=s(897),p=s(6784),x=s(4035),g=s(432),v=s(3619),y=s(8504),N=s(8571);let w=["Looking for the perfect voice match for you :)","Hang tight! Connecting you to someone new...","You're in line - we're working hard to find a connection :)","Still searching... Thanks for your patience :)","Almost there! A new voice chat partner is on the way :)"];function j(){var e,t,s,j,b,k;let{toast:S}=(0,v.pm)(),C=(0,y.useRouter)(),[_,E]=(0,n.useState)("idle"),[T,R]=(0,n.useState)(!1),[A,I]=(0,n.useState)(!0),[O,V]=(0,n.useState)(1200),[z,Z]=(0,n.useState)(null),[D,F]=(0,n.useState)(null),[P,M]=(0,n.useState)(0),U=(0,n.useRef)(null),q=(0,n.useRef)(null),J=(0,n.useRef)(null),W=(0,n.useRef)(null),L=(0,n.useRef)(null),Y=(0,n.useCallback)(async()=>{try{let e=localStorage.getItem("pharmx_token");if(!e)return S({title:"Authentication Required",description:"Please log in to start voice chat",variant:"destructive"}),!1;let t=(N.env.NEXT_PUBLIC_API_URL||"https://pharmx-api.kasimhussain333.workers.dev/api/v1").replace("https://","wss://").replace("http://","ws://");console.log("[Voice] Connecting to WebSocket:","".concat(t,"/match"));let s=new WebSocket("".concat(t,"/match"));return W.current=s,s.onopen=()=>{console.log("[Voice] WebSocket connected");try{let t=e.split(".");if(3===t.length){let e=JSON.parse(atob(t[1].replace(/-/g,"+").replace(/_/g,"/"))).sub;console.log("[Voice] Sending join with userId:",e),s.send(JSON.stringify({type:"join",userId:e}))}else console.error("[Voice] Invalid token format"),s.close()}catch(e){console.error("[Voice] Failed to parse token:",e),s.close()}},s.onmessage=e=>{let t=JSON.parse(e.data);console.log("[Voice] Received message:",t),Q(t)},s.onerror=e=>{console.error("[Voice] WebSocket error:",e),E("idle"),S({title:"Connection Error",description:"Failed to connect to voice service",variant:"destructive"})},s.onclose=e=>{console.log("[Voice] WebSocket closed:",e.code,e.reason),"idle"!==_&&E("idle")},!0}catch(e){return console.error("[Voice] Failed to connect to matchmaking:",e),!1}},[_,S]),Q=(0,n.useCallback)(e=>{switch(console.log("[Voice] Processing message:",e),e.type){case"queued":console.log("[Voice] User queued, waiting for match..."),E("searching");break;case"queueUpdate":console.log("[Voice] Queue update, ETA:",e.etaSeconds,"seconds");break;case"match":console.log("[Voice] Match found! Room code:",e.roomCode);let t=localStorage.getItem("pharmx_user"),s=t?JSON.parse(t).sub:null;s&&fetch("".concat(N.env.NEXT_PUBLIC_API_URL,"/users/").concat(s),{headers:{Authorization:"Bearer ".concat(localStorage.getItem("pharmx_token"))}}).then(e=>e.json()).then(e=>{F({name:e.name||"Anonymous",avatar:e.avatar_url||"",id:e.id}),E("incoming_call")}).catch(()=>{F({name:"Anonymous",avatar:"",id:"unknown"}),E("incoming_call")});break;case"call-accepted":B();break;case"call-declined":E("searching"),F(null);break;case"offer":$(e.sdp);break;case"answer":G(e.sdp);break;case"ice":X(e.candidate);break;case"call-started":E("in_call"),V(e.remainingSec||1200);break;case"tick":V(e.remainingSec);break;case"call-ended":E("deciding"),H();break;case"decision-waiting":break;case"decision-result":"stayinchat"===e.result?(S({title:"Great!",description:"You can now chat with this person in your messages",variant:"default"}),C.push("/app/chats")):(E("idle"),F(null),Z(null));break;case"error":console.error("[Voice] Server error:",e.message),E("idle"),S({title:"Error",description:e.message||"An error occurred",variant:"destructive"})}},[S,C]),B=(0,n.useCallback)(async()=>{try{let e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.cloudflare.com:3478"},{urls:"stun:stun.l.google.com:19302"}],iceCandidatePoolSize:10,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});L.current=e,U.current&&U.current.getTracks().forEach(t=>{e.addTrack(t,U.current)}),e.ontrack=e=>{console.log("[Voice] Received remote track"),q.current&&e.streams[0]&&(q.current.srcObject=e.streams[0])},e.onicecandidate=e=>{e.candidate&&W.current&&W.current.send(JSON.stringify({type:"ice",candidate:e.candidate}))},e.onconnectionstatechange=()=>{console.log("[Voice] Connection state:",e.connectionState),"connected"===e.connectionState?(E("in_call"),W.current&&W.current.send(JSON.stringify({type:"ready"}))):"failed"===e.connectionState&&(S({title:"Connection Failed",description:"Voice call connection failed",variant:"destructive"}),en())}}catch(e){console.error("[Voice] Failed to setup WebRTC:",e)}},[]),$=(0,n.useCallback)(async e=>{if(L.current)try{await L.current.setRemoteDescription(new RTCSessionDescription(e));let t=await L.current.createAnswer();await L.current.setLocalDescription(t),W.current&&W.current.send(JSON.stringify({type:"answer",sdp:t}))}catch(e){console.error("[Voice] Failed to handle offer:",e)}},[]),G=(0,n.useCallback)(async e=>{if(L.current)try{await L.current.setRemoteDescription(new RTCSessionDescription(e))}catch(e){console.error("[Voice] Failed to handle answer:",e)}},[]),X=(0,n.useCallback)(async e=>{if(L.current)try{await L.current.addIceCandidate(new RTCIceCandidate(e))}catch(e){console.error("[Voice] Failed to add ICE candidate:",e)}},[]),H=(0,n.useCallback)(()=>{L.current&&(L.current.close(),L.current=null)},[]),K=async()=>{if(U.current)return U.current;try{var e;let t=await (null===(e=navigator.permissions)||void 0===e?void 0:e.query({name:"microphone"}));if(t&&"denied"===t.state)throw Error("Microphone permission denied")}catch(e){}let t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!1}});U.current=t;try{localStorage.setItem("micPermission","granted")}catch(e){}return t};(0,n.useEffect)(()=>{"granted"===localStorage.getItem("micPermission")&&navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>e.getTracks().forEach(e=>e.stop())).catch(()=>{})},[]),(0,n.useEffect)(()=>{if("searching"!==_)return;let e=setInterval(()=>{M(e=>(e+1)%w.length)},3e3);return()=>clearInterval(e)},[_]),(0,n.useEffect)(()=>{if("in_call"!==_)return;let e=setInterval(()=>{V(e=>e<=1?(en(),0):e-1)},1e3);return J.current=e,()=>clearInterval(e)},[_]);let ee=(0,n.useCallback)(async()=>{try{if(await K(),E("searching"),!await Y()){E("idle");return}}catch(e){console.error("Failed to start voice search:",e),E("idle"),e instanceof Error&&e.message.includes("Microphone")?S({title:"Microphone Access Required",description:"Please allow microphone access to use voice chat",variant:"destructive"}):S({title:"Connection Failed",description:"Please check your internet connection and try again",variant:"destructive"})}},[S,Y]),et=(0,n.useCallback)(()=>{E("idle"),W.current&&(W.current.send(JSON.stringify({type:"leave"})),W.current.close(),W.current=null)},[]),es=(0,n.useCallback)(async()=>{E("connecting"),W.current&&W.current.send(JSON.stringify({type:"accept"}))},[]),ea=(0,n.useCallback)(()=>{E("idle"),F(null),W.current&&W.current.send(JSON.stringify({type:"decline"}))},[]),en=(0,n.useCallback)(()=>{U.current&&(U.current.getTracks().forEach(e=>e.stop()),U.current=null),J.current&&(clearInterval(J.current),J.current=null),H(),W.current&&W.current.send(JSON.stringify({type:"leave"})),E("deciding")},[H]),er=(0,n.useCallback)(()=>{R(e=>{let t=!e;return U.current&&U.current.getAudioTracks().forEach(e=>{e.enabled=!t}),t})},[]),ec=(0,n.useCallback)(()=>{I(e=>!e)},[]),ei=(0,n.useCallback)(async e=>{Z(e),E("waiting_decision"),W.current&&W.current.send(JSON.stringify({type:"decision",choice:e}))},[]);return(0,n.useEffect)(()=>()=>{U.current&&U.current.getTracks().forEach(e=>e.stop()),J.current&&clearInterval(J.current),W.current&&W.current.close(),H()},[H]),(0,a.jsxs)("div",{className:"flex items-center justify-center min-h-[calc(100vh-8rem)] px-4",children:[(0,a.jsx)("audio",{ref:q,autoPlay:!0,playsInline:!0}),"idle"===_&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold",children:"Ready to chat?"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"Connect with someone new through voice"})]}),(0,a.jsxs)(r.z,{size:"lg",className:"w-full h-16 text-lg rounded-2xl",onClick:ee,children:[(0,a.jsx)(l.Z,{className:"mr-2 h-5 w-5"}),"Find a Voice"]})]}),"searching"===_&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"relative h-32 flex items-center justify-center",children:[(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,a.jsx)("div",{className:"w-24 h-24 rounded-full bg-primary/10 animate-ping"})}),(0,a.jsx)(o.Z,{className:"h-12 w-12 animate-spin text-primary"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-lg font-medium",children:"Finding someone…"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground transition-all duration-300",children:w[P]})]})]}),(0,a.jsx)(r.z,{variant:"outline",size:"lg",className:"w-full",onClick:et,children:"Cancel"})]}),"incoming_call"===_&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsxs)(i.qE,{className:"h-24 w-24 mx-auto",children:[(0,a.jsx)(i.F$,{src:null==D?void 0:D.avatar,alt:null==D?void 0:D.name}),(0,a.jsx)(i.Q5,{className:"text-2xl",children:(null==D?void 0:null===(t=D.name)||void 0===t?void 0:null===(e=t.charAt(0))||void 0===e?void 0:e.toUpperCase())||"?"})]}),(0,a.jsx)("div",{className:"absolute -bottom-2 left-1/2 transform -translate-x-1/2",children:(0,a.jsx)("div",{className:"bg-green-500 text-white px-3 py-1 rounded-full text-xs font-medium animate-pulse",children:"Incoming Call"})})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("h3",{className:"text-xl font-semibold",children:null==D?void 0:D.name}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"wants to voice chat with you"})]})]})}),(0,a.jsxs)("div",{className:"flex space-x-4",children:[(0,a.jsxs)(r.z,{variant:"destructive",size:"lg",className:"flex-1",onClick:ea,children:[(0,a.jsx)(d.Z,{className:"mr-2 h-5 w-5"}),"Decline"]}),(0,a.jsxs)(r.z,{variant:"default",size:"lg",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:es,children:[(0,a.jsx)(l.Z,{className:"mr-2 h-5 w-5"}),"Accept"]})]})]}),"connecting"===_&&(0,a.jsx)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:(0,a.jsxs)("div",{className:"space-y-4",children:[D&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(i.qE,{className:"h-20 w-20 mx-auto",children:[(0,a.jsx)(i.F$,{src:null==D?void 0:D.avatar,alt:null==D?void 0:D.name}),(0,a.jsx)(i.Q5,{className:"text-lg",children:(null==D?void 0:null===(j=D.name)||void 0===j?void 0:null===(s=j.charAt(0))||void 0===s?void 0:s.toUpperCase())||"?"})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:null==D?void 0:D.name}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Waiting for the other person to connect…"})]})]}),!D&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)(o.Z,{className:"h-12 w-12 animate-spin text-primary mx-auto"}),(0,a.jsx)("p",{className:"text-lg font-medium",children:"Waiting for the other person to connect…"})]})]})}),"in_call"===_&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[D&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(i.qE,{className:"h-20 w-20 mx-auto",children:[(0,a.jsx)(i.F$,{src:null==D?void 0:D.avatar,alt:null==D?void 0:D.name}),(0,a.jsx)(i.Q5,{className:"text-lg",children:(null==D?void 0:null===(k=D.name)||void 0===k?void 0:null===(b=k.charAt(0))||void 0===b?void 0:b.toUpperCase())||"?"})]}),(0,a.jsx)("h3",{className:"text-lg font-semibold",children:null==D?void 0:D.name})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"You're connected"}),(0,a.jsxs)("div",{className:"flex items-center justify-center space-x-2",children:[(0,a.jsx)(u.Z,{className:"h-5 w-5 text-primary"}),(0,a.jsx)("p",{className:"text-2xl font-bold font-mono",children:"".concat(Math.floor(O/60),":").concat((O%60).toString().padStart(2,"0"))}),(0,a.jsx)("span",{className:"text-sm text-muted-foreground",children:"remaining"})]})]}),(0,a.jsxs)("div",{className:"flex justify-center space-x-4",children:[(0,a.jsx)(r.z,{size:"icon",variant:T?"destructive":"secondary",className:"h-12 w-12 rounded-full",onClick:er,children:T?(0,a.jsx)(m.Z,{className:"h-5 w-5"}):(0,a.jsx)(h.Z,{className:"h-5 w-5"})}),(0,a.jsx)(r.z,{size:"icon",variant:A?"default":"secondary",className:"h-12 w-12 rounded-full",onClick:ec,children:A?(0,a.jsx)(f.Z,{className:"h-5 w-5"}):(0,a.jsx)(p.Z,{className:"h-5 w-5"})})]})]}),(0,a.jsxs)(r.z,{variant:"destructive",size:"lg",className:"w-full",onClick:en,children:[(0,a.jsx)(x.Z,{className:"mr-2 h-5 w-5"}),"End Call"]})]}),"deciding"===_&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"text-xl font-semibold",children:"Choose what happens next"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Would you like to stay in touch?"})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(r.z,{size:"lg",className:"w-full",onClick:()=>ei("stay"),children:[(0,a.jsx)(g.Z,{className:"mr-2 h-5 w-5"}),"Stay in touch"]}),(0,a.jsxs)(r.z,{variant:"outline",size:"lg",className:"w-full",onClick:()=>ei("skip"),children:[(0,a.jsx)(d.Z,{className:"mr-2 h-5 w-5"}),"Skip"]})]})]}),"waiting_decision"===_&&(0,a.jsx)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)(o.Z,{className:"h-12 w-12 animate-spin text-primary mx-auto"}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-lg font-medium",children:"Waiting for their choice…"}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:["You chose to ","stay"===z?"stay in touch":"skip"]})]})]})})]})}},2211:function(e,t,s){"use strict";s.d(t,{F$:function(){return l},Q5:function(){return o},qE:function(){return i}});var a=s(7821),n=s(8078),r=s(4694),c=s(3892);let i=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.fC,{ref:t,className:(0,c.cn)("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...n})});i.displayName=r.fC.displayName;let l=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.Ee,{ref:t,className:(0,c.cn)("aspect-square h-full w-full",s),...n})});l.displayName=r.Ee.displayName;let o=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.NY,{ref:t,className:(0,c.cn)("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...n})});o.displayName=r.NY.displayName},7469:function(e,t,s){"use strict";s.d(t,{z:function(){return o}});var a=s(7821),n=s(8078),r=s(7035),c=s(898),i=s(3892);let l=(0,c.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),o=n.forwardRef((e,t)=>{let{className:s,variant:n,size:c,asChild:o=!1,...d}=e,u=o?r.g7:"button";return(0,a.jsx)(u,{className:(0,i.cn)(l({variant:n,size:c,className:s})),ref:t,...d})});o.displayName="Button"},7769:function(e,t,s){"use strict";s.d(t,{Zb:function(){return c}});var a=s(7821),n=s(8078),r=s(3892);let c=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("rounded-xl border bg-card text-card-foreground shadow",s),...n})});c.displayName="Card",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("flex flex-col space-y-1.5 p-6",s),...n})}).displayName="CardHeader",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("font-semibold leading-none tracking-tight",s),...n})}).displayName="CardTitle",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("text-sm text-muted-foreground",s),...n})}).displayName="CardDescription",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("p-6 pt-0",s),...n})}).displayName="CardContent",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("flex items-center p-6 pt-0",s),...n})}).displayName="CardFooter"},3619:function(e,t,s){"use strict";s.d(t,{pm:function(){return m}});var a=s(8078);let n=0,r=new Map,c=e=>{if(r.has(e))return;let t=setTimeout(()=>{r.delete(e),d({type:"REMOVE_TOAST",toastId:e})},1e6);r.set(e,t)},i=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:s}=t;return s?c(s):e.toasts.forEach(e=>{c(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===s||void 0===s?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},l=[],o={toasts:[]};function d(e){o=i(o,e),l.forEach(e=>{e(o)})}function u(e){let{...t}=e,s=(n=(n+1)%Number.MAX_SAFE_INTEGER).toString(),a=()=>d({type:"DISMISS_TOAST",toastId:s});return d({type:"ADD_TOAST",toast:{...t,id:s,open:!0,onOpenChange:e=>{e||a()}}}),{id:s,dismiss:a,update:e=>d({type:"UPDATE_TOAST",toast:{...e,id:s}})}}function m(){let[e,t]=a.useState(o);return a.useEffect(()=>(l.push(t),()=>{let e=l.indexOf(t);e>-1&&l.splice(e,1)}),[e]),{...e,toast:u,dismiss:e=>d({type:"DISMISS_TOAST",toastId:e})}}},3892:function(e,t,s){"use strict";s.d(t,{cn:function(){return r}});var a=s(2605),n=s(1638);function r(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,n.m6)((0,a.W)(t))}}},function(e){e.O(0,[966,893,115,364,744],function(){return e(e.s=456)}),_N_E=e.O()}]);