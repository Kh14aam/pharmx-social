(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[598],{8571:function(e){var t,n,r,o=e.exports={};function i(){throw Error("setTimeout has not been defined")}function a(){throw Error("clearTimeout has not been defined")}function s(e){if(t===setTimeout)return setTimeout(e,0);if((t===i||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:i}catch(e){t=i}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(e){n=a}}();var c=[],l=!1,u=-1;function h(){l&&r&&(l=!1,r.length?c=r.concat(c):u=-1,c.length&&f())}function f(){if(!l){var e=s(h);l=!0;for(var t=c.length;t;){for(r=c,c=[];++u<t;)r&&r[u].run();u=-1,t=c.length}r=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function g(){}o.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new d(e,t)),1!==c.length||l||s(f)},d.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=g,o.addListener=g,o.once=g,o.off=g,o.removeListener=g,o.removeAllListeners=g,o.emit=g,o.prependListener=g,o.prependOnceListener=g,o.listeners=function(e){return[]},o.binding=function(e){throw Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw Error("process.chdir is not supported")},o.umask=function(){return 0}},9350:function(e,t,n){Promise.resolve().then(n.bind(n,9045))},9045:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return c}});var r=n(7821),o=n(8078),i=n(8504),a=n(8571);function s(){let e=(0,i.useRouter)(),t=(0,i.useSearchParams)(),[n,s]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{(async()=>{if(n)return;let r=t.get("code"),o=t.get("error"),i=t.get("state");if(console.log("[Login Callback] Received:",{code:!!r,error:o,state:i}),o){console.error("[Login Callback] OAuth error:",o),s(!0),e.push("/login");return}if(!r){console.error("[Login Callback] No authorization code received"),s(!0),e.push("/login");return}if(i!==localStorage.getItem("oauth_state")){console.error("[Login Callback] State mismatch - possible CSRF attack"),s(!0),e.push("/login");return}try{console.log("[Login Callback] Exchanging code with backend...");let t=a.env.NEXT_PUBLIC_API_URL||"https://pharmx-api.kasimhussain333.workers.dev/api/v1",n=await fetch("".concat(t,"/oauth/google/exchange"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:r})});if(console.log("[Login Callback] Backend response status:",n.status),!n.ok){let t=await n.text();console.error("[Login Callback] Backend error:",t),s(!0),e.push("/login");return}let o=await n.json();console.log("[Login Callback] Success:",{hasUser:!!o.user,hasTokens:!!o.tokens});let{user:i,tokens:c}=o;if(i&&(null==c?void 0:c.id_token)){localStorage.setItem("pharmx_user",JSON.stringify(i)),localStorage.setItem("pharmx_token",c.id_token),localStorage.removeItem("oauth_state"),console.log("[Login Callback] Checking for existing profile...");try{let n=await fetch("".concat(t,"/profile"),{method:"GET",headers:{Authorization:"Bearer ".concat(c.id_token),"Content-Type":"application/json"}});if(n.ok){let t=await n.json();if(console.log("[Login Callback] Profile found:",{hasName:!!t.name}),t&&t.name){console.log("[Login Callback] Existing user - redirecting to app"),s(!0),e.push("/app/voice");return}}console.log("[Login Callback] No profile found - redirecting to onboarding"),s(!0),e.push("/onboarding");return}catch(t){console.log("[Login Callback] Profile check failed (new user) - redirecting to onboarding"),s(!0),e.push("/onboarding");return}}console.error("[Login Callback] Invalid response format"),s(!0),e.push("/login")}catch(t){console.error("[Login Callback] Network error:",t),s(!0),e.push("/login")}})()},[t,e,n]),(0,r.jsx)("div",{className:"min-h-screen bg-black flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"}),(0,r.jsx)("p",{className:"text-white",children:"Completing sign in..."})]})})}function c(){return(0,r.jsx)(o.Suspense,{fallback:(0,r.jsx)("div",{className:"min-h-screen bg-black flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"}),(0,r.jsx)("p",{className:"text-white",children:"Loading..."})]})}),children:(0,r.jsx)(s,{})})}},8504:function(e,t,n){"use strict";var r=n(3226);n.o(r,"usePathname")&&n.d(t,{usePathname:function(){return r.usePathname}}),n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[115,364,744],function(){return e(e.s=9350)}),_N_E=e.O()}]);