(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[705],{1792:function(e,t,s){Promise.resolve().then(s.bind(s,808))},808:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return w}});var a=s(7437),n=s(2265),r=s(2869),c=s(6070),i=s(6831),l=s(3041),o=s(1817),d=s(2489),u=s(1723),m=s(730),h=s(8662),f=s(1706),p=s(8623),x=s(7133),g=s(8997),v=s(5153),y=s(9376);let N=["Looking for the perfect voice match for you :)","Hang tight! Connecting you to someone new...","You're in line - we're working hard to find a connection :)","Still searching... Thanks for your patience :)","Almost there! A new voice chat partner is on the way :)"];function w(){var e,t,s,w,j,b;let{toast:k}=(0,v.pm)(),S=(0,y.useRouter)(),[C,E]=(0,n.useState)("idle"),[T,_]=(0,n.useState)(!1),[R,A]=(0,n.useState)(!0),[I,O]=(0,n.useState)(1200),[V,z]=(0,n.useState)(null),[Z,D]=(0,n.useState)(null),[F,M]=(0,n.useState)(0),P=(0,n.useRef)(null),q=(0,n.useRef)(null),J=(0,n.useRef)(null),W=(0,n.useRef)(null),U=(0,n.useRef)(null),Y=(0,n.useCallback)(async()=>{try{let e=localStorage.getItem("pharmx_token");if(!e)return k({title:"Authentication Required",description:"Please log in to start voice chat",variant:"destructive"}),!1;let t="https://pharmx-api.kasimhussain333.workers.dev".replace("https://","wss://").replace("http://","ws://");console.log("[Voice] Connecting to WebSocket:","".concat(t,"/match"));let s=new WebSocket("".concat(t,"/match"));return W.current=s,s.onopen=()=>{console.log("[Voice] WebSocket connected");try{let t=e.split(".");if(3===t.length){let e=JSON.parse(atob(t[1].replace(/-/g,"+").replace(/_/g,"/"))).sub;console.log("[Voice] Sending join with userId:",e),s.send(JSON.stringify({type:"join",userId:e}))}else console.error("[Voice] Invalid token format"),s.close()}catch(e){console.error("[Voice] Failed to parse token:",e),s.close()}},s.onmessage=e=>{let t=JSON.parse(e.data);console.log("[Voice] Received message:",t),Q(t)},s.onerror=e=>{console.error("[Voice] WebSocket error:",e),E("idle"),k({title:"Connection Error",description:"Failed to connect to voice service",variant:"destructive"})},s.onclose=e=>{console.log("[Voice] WebSocket closed:",e.code,e.reason),"idle"!==C&&E("idle")},!0}catch(e){return console.error("[Voice] Failed to connect to matchmaking:",e),!1}},[C,k]),Q=(0,n.useCallback)(e=>{switch(console.log("[Voice] Processing message:",e),e.type){case"queued":console.log("[Voice] User queued, waiting for match..."),E("searching");break;case"queueUpdate":console.log("[Voice] Queue update, ETA:",e.etaSeconds,"seconds");break;case"match":console.log("[Voice] Match found! Room code:",e.roomCode);let t=localStorage.getItem("pharmx_user"),s=t?JSON.parse(t).sub:null;s&&fetch("".concat("https://pharmx-api.kasimhussain333.workers.dev","/users/").concat(s),{headers:{Authorization:"Bearer ".concat(localStorage.getItem("pharmx_token"))}}).then(e=>e.json()).then(e=>{D({name:e.name||"Anonymous",avatar:e.avatar_url||"",id:e.id}),E("incoming_call")}).catch(()=>{D({name:"Anonymous",avatar:"",id:"unknown"}),E("incoming_call")});break;case"call-accepted":$();break;case"call-declined":E("searching"),D(null);break;case"offer":G(e.sdp);break;case"answer":B(e.sdp);break;case"ice":H(e.candidate);break;case"call-started":E("in_call"),O(e.remainingSec||1200);break;case"tick":O(e.remainingSec);break;case"call-ended":E("deciding"),L();break;case"decision-waiting":break;case"decision-result":"stayinchat"===e.result?(k({title:"Great!",description:"You can now chat with this person in your messages",variant:"default"}),S.push("/app/chats")):(E("idle"),D(null),z(null));break;case"error":console.error("[Voice] Server error:",e.message),E("idle"),k({title:"Error",description:e.message||"An error occurred",variant:"destructive"})}},[k,S]),$=(0,n.useCallback)(async()=>{try{let e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.cloudflare.com:3478"},{urls:"stun:stun.l.google.com:19302"}],iceCandidatePoolSize:10,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});U.current=e,P.current&&P.current.getTracks().forEach(t=>{e.addTrack(t,P.current)}),e.ontrack=e=>{console.log("[Voice] Received remote track"),q.current&&e.streams[0]&&(q.current.srcObject=e.streams[0])},e.onicecandidate=e=>{e.candidate&&W.current&&W.current.send(JSON.stringify({type:"ice",candidate:e.candidate}))},e.onconnectionstatechange=()=>{console.log("[Voice] Connection state:",e.connectionState),"connected"===e.connectionState?(E("in_call"),W.current&&W.current.send(JSON.stringify({type:"ready"}))):"failed"===e.connectionState&&(k({title:"Connection Failed",description:"Voice call connection failed",variant:"destructive"}),ea())}}catch(e){console.error("[Voice] Failed to setup WebRTC:",e)}},[]),G=(0,n.useCallback)(async e=>{if(U.current)try{await U.current.setRemoteDescription(new RTCSessionDescription(e));let t=await U.current.createAnswer();await U.current.setLocalDescription(t),W.current&&W.current.send(JSON.stringify({type:"answer",sdp:t}))}catch(e){console.error("[Voice] Failed to handle offer:",e)}},[]),B=(0,n.useCallback)(async e=>{if(U.current)try{await U.current.setRemoteDescription(new RTCSessionDescription(e))}catch(e){console.error("[Voice] Failed to handle answer:",e)}},[]),H=(0,n.useCallback)(async e=>{if(U.current)try{await U.current.addIceCandidate(new RTCIceCandidate(e))}catch(e){console.error("[Voice] Failed to add ICE candidate:",e)}},[]),L=(0,n.useCallback)(()=>{U.current&&(U.current.close(),U.current=null)},[]),X=async()=>{if(P.current)return P.current;try{var e;let t=await (null===(e=navigator.permissions)||void 0===e?void 0:e.query({name:"microphone"}));if(t&&"denied"===t.state)throw Error("Microphone permission denied")}catch(e){}let t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!1}});P.current=t;try{localStorage.setItem("micPermission","granted")}catch(e){}return t};(0,n.useEffect)(()=>{"granted"===localStorage.getItem("micPermission")&&navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>e.getTracks().forEach(e=>e.stop())).catch(()=>{})},[]),(0,n.useEffect)(()=>{if("searching"!==C)return;let e=setInterval(()=>{M(e=>(e+1)%N.length)},3e3);return()=>clearInterval(e)},[C]),(0,n.useEffect)(()=>{if("in_call"!==C)return;let e=setInterval(()=>{O(e=>e<=1?(ea(),0):e-1)},1e3);return J.current=e,()=>clearInterval(e)},[C]);let K=(0,n.useCallback)(async()=>{try{if(await X(),E("searching"),!await Y()){E("idle");return}}catch(e){console.error("Failed to start voice search:",e),E("idle"),e instanceof Error&&e.message.includes("Microphone")?k({title:"Microphone Access Required",description:"Please allow microphone access to use voice chat",variant:"destructive"}):k({title:"Connection Failed",description:"Please check your internet connection and try again",variant:"destructive"})}},[k,Y]),ee=(0,n.useCallback)(()=>{E("idle"),W.current&&(W.current.send(JSON.stringify({type:"leave"})),W.current.close(),W.current=null)},[]),et=(0,n.useCallback)(async()=>{E("connecting"),W.current&&W.current.send(JSON.stringify({type:"accept"}))},[]),es=(0,n.useCallback)(()=>{E("idle"),D(null),W.current&&W.current.send(JSON.stringify({type:"decline"}))},[]),ea=(0,n.useCallback)(()=>{P.current&&(P.current.getTracks().forEach(e=>e.stop()),P.current=null),J.current&&(clearInterval(J.current),J.current=null),L(),W.current&&W.current.send(JSON.stringify({type:"leave"})),E("deciding")},[L]),en=(0,n.useCallback)(()=>{_(e=>{let t=!e;return P.current&&P.current.getAudioTracks().forEach(e=>{e.enabled=!t}),t})},[]),er=(0,n.useCallback)(()=>{A(e=>!e)},[]),ec=(0,n.useCallback)(async e=>{z(e),E("waiting_decision"),W.current&&W.current.send(JSON.stringify({type:"decision",choice:e}))},[]);return(0,n.useEffect)(()=>()=>{P.current&&P.current.getTracks().forEach(e=>e.stop()),J.current&&clearInterval(J.current),W.current&&W.current.close(),L()},[L]),(0,a.jsxs)("div",{className:"flex items-center justify-center min-h-[calc(100vh-8rem)] px-4",children:[(0,a.jsx)("audio",{ref:q,autoPlay:!0,playsInline:!0}),"idle"===C&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold",children:"Ready to chat?"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"Connect with someone new through voice"})]}),(0,a.jsxs)(r.z,{size:"lg",className:"w-full h-16 text-lg rounded-2xl",onClick:K,children:[(0,a.jsx)(l.Z,{className:"mr-2 h-5 w-5"}),"Find a Voice"]})]}),"searching"===C&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"relative h-32 flex items-center justify-center",children:[(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,a.jsx)("div",{className:"w-24 h-24 rounded-full bg-primary/10 animate-ping"})}),(0,a.jsx)(o.Z,{className:"h-12 w-12 animate-spin text-primary"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-lg font-medium",children:"Finding someone…"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground transition-all duration-300",children:N[F]})]})]}),(0,a.jsx)(r.z,{variant:"outline",size:"lg",className:"w-full",onClick:ee,children:"Cancel"})]}),"incoming_call"===C&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsxs)(i.qE,{className:"h-24 w-24 mx-auto",children:[(0,a.jsx)(i.F$,{src:null==Z?void 0:Z.avatar,alt:null==Z?void 0:Z.name}),(0,a.jsx)(i.Q5,{className:"text-2xl",children:(null==Z?void 0:null===(t=Z.name)||void 0===t?void 0:null===(e=t.charAt(0))||void 0===e?void 0:e.toUpperCase())||"?"})]}),(0,a.jsx)("div",{className:"absolute -bottom-2 left-1/2 transform -translate-x-1/2",children:(0,a.jsx)("div",{className:"bg-green-500 text-white px-3 py-1 rounded-full text-xs font-medium animate-pulse",children:"Incoming Call"})})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("h3",{className:"text-xl font-semibold",children:null==Z?void 0:Z.name}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"wants to voice chat with you"})]})]})}),(0,a.jsxs)("div",{className:"flex space-x-4",children:[(0,a.jsxs)(r.z,{variant:"destructive",size:"lg",className:"flex-1",onClick:es,children:[(0,a.jsx)(d.Z,{className:"mr-2 h-5 w-5"}),"Decline"]}),(0,a.jsxs)(r.z,{variant:"default",size:"lg",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:et,children:[(0,a.jsx)(l.Z,{className:"mr-2 h-5 w-5"}),"Accept"]})]})]}),"connecting"===C&&(0,a.jsx)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:(0,a.jsxs)("div",{className:"space-y-4",children:[Z&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(i.qE,{className:"h-20 w-20 mx-auto",children:[(0,a.jsx)(i.F$,{src:null==Z?void 0:Z.avatar,alt:null==Z?void 0:Z.name}),(0,a.jsx)(i.Q5,{className:"text-lg",children:(null==Z?void 0:null===(w=Z.name)||void 0===w?void 0:null===(s=w.charAt(0))||void 0===s?void 0:s.toUpperCase())||"?"})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:null==Z?void 0:Z.name}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Waiting for the other person to connect…"})]})]}),!Z&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)(o.Z,{className:"h-12 w-12 animate-spin text-primary mx-auto"}),(0,a.jsx)("p",{className:"text-lg font-medium",children:"Waiting for the other person to connect…"})]})]})}),"in_call"===C&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[Z&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(i.qE,{className:"h-20 w-20 mx-auto",children:[(0,a.jsx)(i.F$,{src:null==Z?void 0:Z.avatar,alt:null==Z?void 0:Z.name}),(0,a.jsx)(i.Q5,{className:"text-lg",children:(null==Z?void 0:null===(b=Z.name)||void 0===b?void 0:null===(j=b.charAt(0))||void 0===j?void 0:j.toUpperCase())||"?"})]}),(0,a.jsx)("h3",{className:"text-lg font-semibold",children:null==Z?void 0:Z.name})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"You're connected"}),(0,a.jsxs)("div",{className:"flex items-center justify-center space-x-2",children:[(0,a.jsx)(u.Z,{className:"h-5 w-5 text-primary"}),(0,a.jsx)("p",{className:"text-2xl font-bold font-mono",children:"".concat(Math.floor(I/60),":").concat((I%60).toString().padStart(2,"0"))}),(0,a.jsx)("span",{className:"text-sm text-muted-foreground",children:"remaining"})]})]}),(0,a.jsxs)("div",{className:"flex justify-center space-x-4",children:[(0,a.jsx)(r.z,{size:"icon",variant:T?"destructive":"secondary",className:"h-12 w-12 rounded-full",onClick:en,children:T?(0,a.jsx)(m.Z,{className:"h-5 w-5"}):(0,a.jsx)(h.Z,{className:"h-5 w-5"})}),(0,a.jsx)(r.z,{size:"icon",variant:R?"default":"secondary",className:"h-12 w-12 rounded-full",onClick:er,children:R?(0,a.jsx)(f.Z,{className:"h-5 w-5"}):(0,a.jsx)(p.Z,{className:"h-5 w-5"})})]})]}),(0,a.jsxs)(r.z,{variant:"destructive",size:"lg",className:"w-full",onClick:ea,children:[(0,a.jsx)(x.Z,{className:"mr-2 h-5 w-5"}),"End Call"]})]}),"deciding"===C&&(0,a.jsxs)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"text-xl font-semibold",children:"Choose what happens next"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Would you like to stay in touch?"})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(r.z,{size:"lg",className:"w-full",onClick:()=>ec("stay"),children:[(0,a.jsx)(g.Z,{className:"mr-2 h-5 w-5"}),"Stay in touch"]}),(0,a.jsxs)(r.z,{variant:"outline",size:"lg",className:"w-full",onClick:()=>ec("skip"),children:[(0,a.jsx)(d.Z,{className:"mr-2 h-5 w-5"}),"Skip"]})]})]}),"waiting_decision"===C&&(0,a.jsx)(c.Zb,{className:"w-full max-w-md p-8 text-center space-y-6",children:(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)(o.Z,{className:"h-12 w-12 animate-spin text-primary mx-auto"}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-lg font-medium",children:"Waiting for their choice…"}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:["You chose to ","stay"===V?"stay in touch":"skip"]})]})]})})]})}},6831:function(e,t,s){"use strict";s.d(t,{F$:function(){return l},Q5:function(){return o},qE:function(){return i}});var a=s(7437),n=s(2265),r=s(1146),c=s(4508);let i=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.fC,{ref:t,className:(0,c.cn)("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...n})});i.displayName=r.fC.displayName;let l=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.Ee,{ref:t,className:(0,c.cn)("aspect-square h-full w-full",s),...n})});l.displayName=r.Ee.displayName;let o=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.NY,{ref:t,className:(0,c.cn)("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...n})});o.displayName=r.NY.displayName},2869:function(e,t,s){"use strict";s.d(t,{z:function(){return o}});var a=s(7437),n=s(2265),r=s(7053),c=s(535),i=s(4508);let l=(0,c.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),o=n.forwardRef((e,t)=>{let{className:s,variant:n,size:c,asChild:o=!1,...d}=e,u=o?r.g7:"button";return(0,a.jsx)(u,{className:(0,i.cn)(l({variant:n,size:c,className:s})),ref:t,...d})});o.displayName="Button"},6070:function(e,t,s){"use strict";s.d(t,{Zb:function(){return c}});var a=s(7437),n=s(2265),r=s(4508);let c=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("rounded-xl border bg-card text-card-foreground shadow",s),...n})});c.displayName="Card",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("flex flex-col space-y-1.5 p-6",s),...n})}).displayName="CardHeader",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("font-semibold leading-none tracking-tight",s),...n})}).displayName="CardTitle",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("text-sm text-muted-foreground",s),...n})}).displayName="CardDescription",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("p-6 pt-0",s),...n})}).displayName="CardContent",n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,r.cn)("flex items-center p-6 pt-0",s),...n})}).displayName="CardFooter"},5153:function(e,t,s){"use strict";s.d(t,{pm:function(){return m}});var a=s(2265);let n=0,r=new Map,c=e=>{if(r.has(e))return;let t=setTimeout(()=>{r.delete(e),d({type:"REMOVE_TOAST",toastId:e})},1e6);r.set(e,t)},i=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:s}=t;return s?c(s):e.toasts.forEach(e=>{c(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===s||void 0===s?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},l=[],o={toasts:[]};function d(e){o=i(o,e),l.forEach(e=>{e(o)})}function u(e){let{...t}=e,s=(n=(n+1)%Number.MAX_SAFE_INTEGER).toString(),a=()=>d({type:"DISMISS_TOAST",toastId:s});return d({type:"ADD_TOAST",toast:{...t,id:s,open:!0,onOpenChange:e=>{e||a()}}}),{id:s,dismiss:a,update:e=>d({type:"UPDATE_TOAST",toast:{...e,id:s}})}}function m(){let[e,t]=a.useState(o);return a.useEffect(()=>(l.push(t),()=>{let e=l.indexOf(t);e>-1&&l.splice(e,1)}),[e]),{...e,toast:u,dismiss:e=>d({type:"DISMISS_TOAST",toastId:e})}}},4508:function(e,t,s){"use strict";s.d(t,{cn:function(){return r}});var a=s(1994),n=s(3335);function r(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,n.m6)((0,a.W)(t))}}},function(e){e.O(0,[317,85,971,117,744],function(){return e(e.s=1792)}),_N_E=e.O()}]);